// Generated by CoffeeScript 1.6.2
/*
	Represents the JJRestApi for global Settings, Events, Models and Collections
	
	Example: Accessible in every module via
	
		define[
			'modules/JJRestApi'
		], (JJRestApi) ->
*/

var JJRestApi;

JJRestApi = {
  url: '/api/v2/',
  extension: 'json',
  structurID: 'api-structure'
};

JJRestApi.Models = {};

JJRestApi.Collections = {};

JJRestApi.Modules = {};

JJRestApi.Modules._modules = [];

JJRestApi.Events = _.extend({}, Backbone.Events);

/* 
 #	Prototype getter
 #
 #	@param string className
 #	@return Backbone.RelationalModel based on className
*/


JJRestApi.Model = function(className) {
  if (this.Models[className]) {
    return this.Models[className];
  } else {
    return false;
  }
};

/*
 #	Collection getter
 #
 #	@param string className
 #	@return Backbone.Collection based on className
*/


JJRestApi.Collection = function(className) {
  if (this.Collections[className]) {
    return this.Collections[className];
  } else {
    return false;
  }
};

/*
 #	Register Modules and extend them after bootstrapping the app structure
 #
 #	@param Object module
 #	@param function extensions in a callback
*/


JJRestApi.Modules.extend = function(module, extension) {
  JJRestApi.Modules._modules.push({
    module: module,
    extension: extension
  });
  return true;
};

JJRestApi.extendModel = function(className, modelToExtendFrom, extension) {
  var model;

  model = this.Model(className);
  if (modelToExtendFrom.prototype instanceof Backbone.Model === false) {
    extension = modelToExtendFrom;
    modelToExtendFrom = model;
  }
  extension || (extension = {});
  if (model) {
    return this.Models[className] = modelToExtendFrom.extend(extension);
  }
};

JJRestApi.extendCollection = function(className, collTypeToExtendFrom, extension) {
  var collType;

  collType = this.Collection(className);
  if (collTypeToExtendFrom instanceof Backbone.Collection === false) {
    extension = collTypeToExtendFrom;
    collTypeToExtendFrom = collType;
  }
  extension || (extension = {});
  if (collType) {
    return this.Collections[className] = collTypeToExtendFrom.extend(extension);
  }
};

JJRestApi.setObjectUrl = function(className) {
  return this.url + className + '.' + this.extension;
};

/**
 *
 * Gets the security token passed by SilverStripe and adds it to every ajax request
 *
*/


JJRestApi.hookSecurityToken = function() {
  return JJRestApi.getFromDomOrApi('SecurityID', {
    noAjax: true
  }).done(function(data) {
    if (data.SecurityID) {
      return $(document).bind('ajaxSend', function(event, xhr, settings) {
        return xhr.setRequestHeader(data.RequestHeader, data.SecurityID);
      });
    }
  });
};

/**
 * Loads an Object from the DOM via #api-object or /api/v2/Object.extension
 * @param  {String} name    name to get/fetch (e.g. ClassName)
 * @param  {Object} options 
 * @return deferred promise object
*/


JJRestApi.getFromDomOrApi = function(name, options) {
  var $obj, data, dfd, nameToSearch, url;

  options = options || {};
  nameToSearch = options.name ? options.name : name.toLowerCase();
  /**
  	 * @todo get the API-prefix from DOM and pass it on from SilverStripe
  */

  $obj = $('#api-' + nameToSearch);
  if ($obj.length) {
    data = $.trim($obj.html());
    if ($obj.attr('type') === 'application/json') {
      data = $.parseJSON(data);
    }
    dfd = new $.Deferred();
    dfd.resolve(data);
    return dfd.promise();
  } else if (!options.noAjax) {
    url = options.url ? options.url : JJRestApi.setObjectUrl(name);
    if (options.urlSuffix) {
      url += options.urlSuffix;
    }
    dfd = $.getJSON(url);
    JJRestApi.Events.trigger('dfdAjax', dfd);
    return dfd;
  }
};

/**
 *
 * Converts an object with search and context to URL String, e.g. 's=Foo:bar&context=view.foobar'
 *
*/


JJRestApi.objToUrlString = function(obj) {
  var k, key, l, returnString, searchString, v, value;

  returnString = '';
  for (key in obj) {
    value = obj[key];
    if (key === ('search' || 's')) {
      searchString = 's=';
      for (k in value) {
        v = value[k];
        searchString += encodeURIComponent(k) + ':';
        searchString += _.isArray(v) ? encodeURIComponent(v.join('|')) : encodeURIComponent(v);
        searchString += ';';
      }
      returnString += searchString;
    } else {
      returnString += encodeURIComponent(key) + '=' + encodeURIComponent(value);
    }
    returnString += '&';
  }
  l = returnString.length;
  if (returnString.lastIndexOf('&') === (l - 1)) {
    returnString = returnString.substr(0, l - 1);
  }
  return returnString;
};

/*
 #	The Bootstrapper rebuilds the JJ_RestfulServer/Structure response as backbone-relational structure
 #
 #	@param callback function
 #	@return false
*/


JJRestApi.bootstrapWithStructure = function(callback) {
  var dfd;

  dfd = JJRestApi.getFromDomOrApi('Structure');
  dfd.done(function(data) {
    return JJRestApi.Bootstrap(data);
  });
  dfd.fail(function() {
    throw new Error('Structure could not be loaded.');
  });
  return dfd;
};

JJRestApi.Bootstrap = function(response) {
  data;
  config;
  var buildPrototype, className, collRegisterObj, collectionsToRegister, config, data, getRelationObj, getRelationType, isMany, module, name, relations, _i, _j, _len, _len1, _ref, _ref1,
    _this = this;

  collectionsToRegister = [];
  getRelationType = function(type) {
    relType;
    var relType;

    switch (type) {
      case 'belongs_to':
        relType = 'has_one';
        break;
      case 'has_one':
        relType = 'has_one';
        break;
      case 'has_many':
        relType = 'has_many';
        break;
      case 'many_many':
        relType = 'many_many';
        break;
      case 'belongs_many_many':
        relType = 'many_many';
    }
    return relType;
  };
  getRelationObj = function(className, relation) {
    var relType, relationObj;

    relType = getRelationType(relation.Type);
    relationObj = {
      type: relType,
      relatedModel: function() {
        return JJRestApi.Model(relation.ClassName);
      },
      key: relation.Key,
      reverseKey: relation.ReverseKey,
      includeInJSON: ['id']
    };
    if (relType !== 'has_one') {
      relationObj.collectionType = relation.ClassName;
      collectionsToRegister.push(relation.ClassName);
    }
    return relationObj;
  };
  isMany = function(type) {
    if (type = 'has_many' || 'many_many') {
      return true;
    } else {
      return false;
    }
  };
  buildPrototype = function(className, relations, config) {
    var field, i, index, modelOptions, relObj, relation, rels, _ref;

    modelOptions = {
      defaults: {}
    };
    rels = [];
    for (i in relations) {
      relation = relations[i];
      if (relObj = getRelationObj(className, relation)) {
        rels.push(relObj);
      }
    }
    if (rels.length) {
      modelOptions.relations = rels;
    }
    modelOptions.storeIdentifier = className;
    modelOptions.url = function() {
      if (this.id) {
        return JJRestApi.url + this.storeIdentifier + '/' + this.id + '.' + JJRestApi.extension;
      } else {
        return this.urlRoot;
      }
    };
    modelOptions.urlRoot = _this.setObjectUrl(className);
    modelOptions.idAttribute = 'ID';
    if (config && config.DefaultFields) {
      _ref = config.DefaultFields;
      for (index in _ref) {
        field = _ref[index];
        modelOptions.defaults[field] = null;
      }
    }
    _this.Models[className] = _this.Model(className).extend(modelOptions);
    return true;
  };
  config = response.Config || false;
  data = response.Config ? response.Objs : response;
  if (!data) {
    return;
  }
  for (className in data) {
    relations = data[className];
    this.Models[className] = Backbone.JJRelationalModel.extend({});
    this.Collections[className] = Backbone.Collection.extend({
      url: this.setObjectUrl(className),
      comparator: function(model) {
        return model.id;
      },
      parse: function(response) {
        return response;
      }
    });
  }
  _ref = JJRestApi.Modules._modules;
  for (_i = 0, _len = _ref.length; _i < _len; _i++) {
    module = _ref[_i];
    module.extension.call(window, module.module);
  }
  for (className in data) {
    relations = data[className];
    buildPrototype(className, relations, config);
    this.Collections[className] = this.Collection(className).extend({
      model: this.Model(className)
    });
  }
  collRegisterObj = {};
  _ref1 = _.uniq(collectionsToRegister);
  for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
    name = _ref1[_j];
    collRegisterObj[name] = this.Collection(name);
  }
  Backbone.JJRelational.registerCollectionTypes(collRegisterObj);
  return false;
};

JJRestApi;
