// Generated by CoffeeScript 1.6.2
define(['app', 'modules/Auth', 'modules/Project', 'modules/Person', 'modules/Excursion', 'modules/Workshop', 'modules/Exhibition', 'modules/CalendarEntry', 'modules/PageError', 'modules/Portfolio', 'modules/Calendar', 'modules/About'], function(app, Auth, Project, Person, Excursion, Workshop, Exhibition, CalendarEntry, PageError, Portfolio, Calendar, About) {
  /**
  	 *
  	 *	All the URL routing is done here.
  	 *	Our router also serves as the data retrieving interface. All data getting logic is
  	 *	handled here. 
  	 *
  */

  var DataRetrieval, Router, called_twice;

  called_twice = false;
  Router = Backbone.Router.extend({
    routes: {
      '': 'index',
      'about/': 'showAboutPage',
      'about/:nameSlug/': 'showPersonPage',
      'about/:nameSlug/:uglyHash/': 'showPersonDetailed',
      'portfolio/': 'showPortfolio',
      'portfolio/:uglyHash/': 'showPortfolioDetailed',
      'calendar/': 'showCalendar',
      'calendar/:urlHash/': 'showCalendarDetailed',
      'login/': 'showLoginForm',
      'logout/': 'doLogout',
      '*url/': 'catchAllRoute'
    },
    index: function(hash) {
      var config, layout,
        _this = this;

      config = app.Config;
      layout = app.useLayout('index');
      DataRetrieval.forProjectsOverview(config.Featured).done(function() {
        var modelsArray;

        modelsArray = _this.getProjectTypeModels({
          IsFeatured: true
        });
        return _this.showGravityViewForModels(modelsArray, 'portfolio', layout);
      });
      return DataRetrieval.forCalendar('upcoming').done(function() {
        var calendarContainer;

        calendarContainer = new Calendar.Views.UpcomingContainer({
          collection: app.Collections.CalendarEntry
        });
        return layout.setViewAndRenderMaybe('#upcoming-calendar', calendarContainer);
      });
    },
    showAboutPage: function() {
      var groupImageDfd, layout, personsDfd;

      layout = app.useLayout('main', {
        customClass: 'about'
      });
      groupImageDfd = DataRetrieval.forRandomGroupImage();
      personsDfd = DataRetrieval.forPersonsOverview();
      $.when(groupImageDfd, personsDfd).done(function(image) {
        var coll, persons, view;

        coll = app.Collections['Person'];
        persons = {
          students: coll.where({
            IsStudent: true
          }),
          alumnis: coll.where({
            IsAlumni: true
          }),
          employees: coll.where({
            IsEmployee: true
          })
        };
        view = new About.Views.GravityContainer({
          groupImage: image,
          persons: persons
        });
        return layout.setViewAndRenderMaybe('', view);
      });
      return false;
    },
    showPersonPage: function(nameSlug) {
      return DataRetrieval.forDetailedObject('Person', nameSlug).done(function(model) {
        var layout, template, view;

        if (!model) {
          return this.fourOhFour();
        }
        layout = app.useLayout('main');
        template = '';
        model.get('Templates').each(function(templ) {
          if (!templ.get('IsDetail')) {
            return template = templ.get('Url');
          }
        });
        view = !template ? new Person.Views.GravityContainer({
          model: model
        }) : new Person.Views.Custom({
          model: model,
          template: template
        });
        return layout.setViewAndRenderMaybe('', view);
      });
    },
    showPersonDetailed: function(nameSlug, uglyHash) {
      return this.showPortfolioDetailed(uglyHash, nameSlug);
    },
    showPortfolio: function() {
      var layout,
        _this = this;

      layout = app.useLayout('portfolio');
      return DataRetrieval.forProjectsOverview(app.Config.Portfolio).done(function() {
        var modelsArray;

        modelsArray = _this.getProjectTypeModels({
          IsPortfolio: true
        });
        return _this.showGravityViewForModels(modelsArray, 'portfolio', layout);
      });
    },
    showPortfolioDetailed: function(uglyHash, nameSlug) {
      var classType,
        _this = this;

      classType = app.Config.ClassEnc[uglyHash.substr(0, 1)];
      if (classType) {
        return DataRetrieval.forDetailedObject(classType, uglyHash).done(function(model) {
          var detailView, layout, person, template;

          console.log(model);
          if (!model || (!nameSlug && !model.get('IsPortfolio'))) {
            return _this.fourOhFour();
          }
          layout = app.useLayout('main', {
            customClass: 'detail'
          });
          template = '';
          if (nameSlug) {
            person = model.get('Persons').where({
              UrlSlug: nameSlug
            });
            if (person.length) {
              person[0].get('Templates').each(function(templ) {
                if (templ.get('IsDetail')) {
                  return template = templ.get('Url');
                }
              });
            }
          }
          detailView = !template ? new Portfolio.Views.Detail({
            model: model
          }) : new Person.Views.Custom({
            model: model,
            template: template
          });
          layout.setViewAndRenderMaybe('', detailView);
          return console.log(app);
        });
      } else {
        return this.fourOhFour();
      }
    },
    showCalendar: function() {
      return console.info('show whole calendar');
    },
    showCalendarDetailed: function(urlHash) {
      var _this = this;

      console.info('get calendar detailed data with slug and show');
      return DataRetrieval.forDetailedObject('CalendarEntry', urlHash).done(function(model) {
        var detailView, layout;

        if (!model) {
          return _this.fourOhFour();
        }
        layout = app.useLayout('main');
        detailView = new Calendar.Views.Detail({
          model: model
        });
        return layout.setViewAndRenderMaybe('', detailView);
      });
    },
    showLoginForm: function() {
      var layout;

      layout = app.useLayout('main');
      console.info('login form. if logged in, redirect to dashboard');
      return Auth.performLoginCheck().done(function() {
        return layout.setViewAndRenderMaybe('', new Auth.Views.Login());
      });
    },
    doLogout: function() {
      var dfd, layout;

      layout = app.useLayout('main');
      dfd = $.Deferred();
      if (app.CurrentMember) {
        layout.setViewAndRenderMaybe('', new Auth.Views.Logout());
        dfd = Auth.logout();
      } else {
        dfd.resolve();
      }
      return dfd.done(function() {
        return Backbone.history.navigate('/login/', true);
      });
    },
    catchAllRoute: function(url) {
      return console.log('catch all route');
    },
    fourOhFour: function() {
      var errorView, layout;

      layout = app.useLayout('main');
      errorView = new PageError.Views.FourOhFour({
        attributes: {
          'data-url': window.location.href
        }
      });
      return layout.setViewAndRenderMaybe('', errorView);
    },
    showGravityViewForModels: function(modelsArray, linkTo, layout) {
      var gravityContainer;

      gravityContainer = new Portfolio.Views.GravityContainer({
        collection: modelsArray,
        linkTo: linkTo
      });
      return layout.setViewAndRenderMaybe('#gravity-container', gravityContainer);
    },
    getProjectTypeModels: function(where) {
      var projectType, returnArray, _i, _len, _ref;

      returnArray = [];
      _ref = app.Config.ProjectTypes;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        projectType = _ref[_i];
        returnArray = returnArray.concat(app.Collections[projectType].where(where));
      }
      return returnArray;
    }
  });
  DataRetrieval = {
    forProjectsOverview: function(configObj) {
      var dfds, present, projectType, projectTypes, returnDfd, _fn, _i, _len;

      present = configObj.present;
      projectTypes = app.Config.ProjectTypes;
      returnDfd = new $.Deferred();
      if (!present.flag) {
        dfds = [];
        _fn = function(projectType) {
          var options;

          options = {
            name: configObj.domName(projectType),
            urlSuffix: configObj.urlSuffix
          };
          return dfds.push(JJRestApi.getFromDomOrApi(projectType, options).done(function(data) {
            return app.handleFetchedModels(projectType, data);
          }));
        };
        for (_i = 0, _len = projectTypes.length; _i < _len; _i++) {
          projectType = projectTypes[_i];
          _fn(projectType);
        }
        $.when.apply(this, dfds).done(function() {
          present.flag = true;
          return returnDfd.resolve();
        });
      } else {
        returnDfd.resolve();
      }
      return returnDfd.promise();
    },
    forCalendar: function(type) {
      var config, dfd, options;

      config = app.Config.Calendar[type];
      dfd = new $.Deferred();
      if (!config.flag) {
        options = _.clone(config);
        options.name = type + '-calendar';
        JJRestApi.getFromDomOrApi('CalendarEntry', options).done(function(data) {
          var item, _i, _len;

          if (type === 'upcoming') {
            for (_i = 0, _len = data.length; _i < _len; _i++) {
              item = data[_i];
              item.IsUpcoming = true;
            }
          }
          app.handleFetchedModels('CalendarEntry', data);
          config.flag = true;
          if (type === 'whole') {
            app.Config.Calendar.upcoming.flag = true;
          }
          return dfd.resolve();
        });
      } else {
        dfd.resolve();
      }
      return dfd.promise();
    },
    forPersonsOverview: function() {
      var config, dfd, options;

      config = app.Config.Person;
      dfd = new $.Deferred();
      if (!config.about_present) {
        options = _.clone(config);
        JJRestApi.getFromDomOrApi('Person', options).done(function(data) {
          config.about_present = true;
          app.handleFetchedModels('Person', data);
          return dfd.resolve();
        });
      } else {
        dfd.resolve();
      }
      return dfd;
    },
    forDetailedObject: function(classType, slug, callback) {
      var coll, configObj, dfd, existModel, options, whereStatement;

      configObj = app.Config.Detail[classType];
      dfd = new $.Deferred();
      coll = app.Collections[classType];
      whereStatement = configObj.where(slug);
      existModel = coll.findWhere(whereStatement);
      if (existModel) {
        if (existModel._isCompletelyFetched) {
          dfd.resolve(existModel);
        } else {
          return this.fetchExistingModelCompletely(existModel);
        }
      } else {
        options = {
          name: configObj.domName,
          urlSuffix: configObj.urlSuffix(slug)
        };
        JJRestApi.getFromDomOrApi(classType, options).done(function(data) {
          var model;

          data = _.isArray(data) ? data : [data];
          model = data.length === 1 ? app.handleFetchedModel(classType, data[0]) : null;
          model._isCompletelyFetched = true;
          return dfd.resolve(model);
        });
      }
      return dfd.promise();
    },
    forRandomGroupImage: function() {
      var dfd, getRandom, pageInfos;

      pageInfos = app.PageInfos;
      dfd = new $.Deferred();
      getRandom = function() {
        var groupImages;

        groupImages = pageInfos.GroupImages;
        if (groupImages.length > 0) {
          return groupImages[Math.floor(Math.random() * groupImages.length)];
        }
        return null;
      };
      if (!pageInfos.GroupImages) {
        JJRestApi.getFromDomOrApi('GroupImage').done(function(data) {
          pageInfos.GroupImages = data;
          return dfd.resolve(getRandom());
        });
      } else {
        dfd.resolve(getRandom());
      }
      return dfd.promise();
    },
    fetchExistingModelCompletely: function(existModel, callback) {
      var dfd;

      dfd = new $.Deferred();
      existModel.fetch({
        success: function(model) {
          dfd.resolve(model);
          return model._isCompletelyFetched = true;
        }
      });
      return dfd.promise();
    }
  };
  return Router;
});
